13.网络安全协议
安全电子邮件
垃圾邮件 增加负荷 占用空间     诈骗邮件 迅速让大量受害者上当     邮件炸弹 短时间发送大量邮件     通过电子邮件/附件传播病毒     欺骗钓鱼攻击
需求  机密性 只有接收方才能阅读    完整性 传输过程不被修改    身份认证  发送者不被假冒    抗抵赖性  发信人无法否认发过电子邮件
原理：单向性 非实时性

标准PEM   运行依赖PKI 如CA    邮件加密 报文完整性 发送方认证 防发送方否认
PGP  事实上标准  各种平台运行  用于普通文件 军事    所有算法被证实为非常安全 公钥加密 对称加密 散列算法
特点：对邮件内容数字签名  使用公钥和对称加密保证内容机密  权威性由收发双方或所信任的第三方签名认证  事先不需要任何保密信道来传递对称的会话密钥
密钥 软件为用户生成公开密钥对 公钥在用户网站/服务器上 私钥使用用户口令进行保护 指定口令       公钥认证机制与传统CA差异较大 PGP通过可信的Web认证 用户可以自己认证 为其他公钥认证提供担保            防止篡改方法 直接得到 电话认证 从双方信任的人那里获得公钥  通过CA
S/MIME标准  提供数据保密/完整性 认证等服务   不仅限于邮件   保护邮件主题  认证机制依赖于层次结构的CA     证书采用X.509规范

Web安全威胁
主动攻击 篡改信息    被动攻击 监听    机密性   完整性    拒绝服务    身份认证
Web服务越强大 包含安全漏洞概率越高  HTTP服务可在不同权限下运行      浏览器安全威胁  活动Web可能隐藏恶意程序      通信信道安全威胁   
基于应用层 SET 电商      传输层 SSL/TLS 基础协议栈 对应用透明 应用层数据会被加密        网络层 IPSec提供端到端安全机制 各种应用程序均可利用减少安全漏洞

SSL
安全套接字层   广泛部署安全协议  几乎所有浏览器和Web服务器支持  https   交易额达数十亿美元   实现：Netscape    变体：TLS      提供 机密性 完整性 认证     目标 电子商务交易 加密 服务器认证 可选客户认证 方便新商户的商务活动        可用于所有基于TCP的网络应用 安全socket接口
SSL和TCP/IP  TCP与应用层间   为网络应用提供应用编程接口  C Java     
需要发送字节流以及交互数据    需要一组密钥用于整个连接    证书交换作为协议一部分 握手阶段
简化SSL    握手 利用证书 私钥认证 交换共享密钥   密钥派生 利用共享密钥    传输数据 将数据分割成一系列记录     连接关闭 发送特殊消息安全关闭连接
                 MS主密钥  EMS加密的主密钥     密钥派生 不同加密操作使用不同密钥会更安全  KDF实现密钥派生
                 数据记录   将字节流分割成一系列记录 每个记录携带一个MAC 接收方可以给对每个记录进行完整性检验      采用变长记录
                 序列号 解决重放/重新排序问题 记录中没有序列号域    使用一次性随机数
                 截断攻击 伪造断连段 一方或双方认为已没有数据发送   记录类型，利用一个类型记录专门用于断连
每个域多长     采用哪种加密协议     需要协商吗 允许客户与服务器支持不同加密算法 数据传输前共同选择特定算法
SSL协议栈 介于HTTP与TCP可选层  绝大多数可直接建立在SSL上    两层协议     握手/更改密码规格  警告          记录协议
SSL密码组  密码组 公开密钥算法 对称加密算法 MAC算法     SSL支持多个密码组  协商 客户与服务器商定密码组 客户提供选项 服务器挑选其一
更改密码规格  更新当前连接的密钥组 标志着加密策略的改变 位于SSL记录协议之上 内容类型=20  协议只包含一条信息
警告协议 Alert消息  位于SSL记录协议上  内容类型=21 包含两个字节 警告字节和警告代码
握手协议 内容类型=22   用到三个协议 握手 更改密码规格 警告   目的 服务器认证/鉴别  协商 商定加密算法 建立密钥 客户认证/鉴别（可选）
记录协议 描述交换过程中记录格式  所有数据都被封装在记录中  由记录头和数据组成

握手过程 发送算法列表及一次随机数    从列表中选择算法 选择+整数+服务器一次随机数     客户验证证书 提取公钥 生成预主密钥 利用公钥加密发送给服务器     客户与服务器分别独立计算加密密钥和MAC密钥     客户发送/服务器发送 针对所有消息的MAC
最好两步保护握手过程免遭篡改   使用两个一次随机数
记录协议 分段成可操作数据块 压缩分块数据 计算MAC 加密压缩数据和MAC 加入SSL记录头 TCP中传输
密钥派生 客户一次数 服务器一次数 预主密钥输入伪随机数发生器     主密钥和新一次随机数输入另一个随机数发生器密钥块   切片得到MAC密钥 加密密钥 初始向量   *2

VPN
专用网PN 安全 基于专属网络设备 链路 协议建设服务于特定组织机构的网络       成本问题
虚拟专用网 安全+成本  通过建立在Internet上安全通道 实现远程安全连接 专用网络     不实际独占公共网络资源 是一条逻辑穿过公共网络安全稳定的隧道
功能 数据机密性保护  完整性  身份认证  防重放攻击  访问控制
关键技术 隧道技术 数据加密 身份认证 密钥管理 访问控制 网络管理
隧道技术 通过Internet提供安全的点到点数据传输的安全通道 实质上是一种封装  利用隧道协议对通过数据进行封装
隧道协议 乘客协议 封装协议 承载协议      常见VPN 第二层隧道 PPTP L2TP    第三层隧道IPSec 网关到网关或主机 不支持拨号
IPSec最安全 适用面最广      SSL高层安全协议优势   L2TP最好   相结合

IPsec
安全体系  封装安全载荷 认证头   加密算法 认证算法  解释域  密钥交换与管理IKE 安全关联SA
服务  机密性 数据完整性 源认证/鉴别  重放攻击预防    两个协议 AH ESP
IPsec数据报的发送和接收均有端系统完成  主机是IPsec感知的 
传输模式  隧道模式 边缘路由器是IPsec感知的
AH认证头协议 51号   ESP协议 50     认证头协议AH 提供源认证/鉴别 数据完整性     封装安全协议ESP提供源认证/鉴别 数据完整性及机密性 比AH应用更广泛

安全关联SA 发送数据前 从发送实体到接受实体之间需要建立SA   单工   发送实体与接受实体均需维护SA状态信息 回顾TCP连接端点也需要维护状态信息 IP无连接 IPsec面向连接
主要参数 索引SPI 32位SA唯一标识ID 加密密钥 认证密钥 密钥算法标识 序列号32位 抗重放攻击 抗重播窗口 滑动窗口检测恶意主机重放数据报 生存周期 SA有效使用周期 运行模式：传输/隧道   隧道源 目的地址
端点将SA状态保存在安全关联数据库SAD中 处理IPsec时定位信息
SPD数据库 安全策略数据库 
SP定义了对什么样的数据流实施什么样的安全处理    应用IPSec 绕过 丢弃   安全策略组成了SPD 每个记录就是一条SP  安全处理所需参数存储在SP指向的SA结构

传输模式AH   AH头 原IP头和数据报载荷之间 
隧道模式  新IP头 AH头 然后原IP头和数据报载荷
传输模式  原 ESP头 原IP数据报 ESP尾部 ESP认证数据    中间3个认证放到最后
隧道模式ESP 新IP头 ESP头 原IP头 原IP数据报载荷 ESP尾部 ESP认证

检索SPD确定处理策略 检索SAD确定SA 原IP数据包后面附加ESP尾部 利用SA定义的算法与密钥加密结果 加密结果前附加ESP头 针对整个enchilada创建MAC 后面附加MAC构成载荷 构造全新IP头包含所有经典IPv4首部 将新IP头附加在载荷前面
原IP数据报中提取选择符搜索SPD确定处理策略 判断是否为IPsec 从头部提取SPI检索SAD 
ESP尾部填充以便应用分组密码  首部 SPI告知该做什么 序列号抵抗重放攻击  MAC字段基于共享的秘密密钥

SA建立与密钥管理 手工方式 所有信息需要手工 永远存在 适用于简单网络    自动方式 通过协商方式 提高了安全性 适用于较复杂拓扑和较高安全性的网络
IKE 在IPsec端点手工建立IPsec SA   几百个端点手工设置不可行   替代方案IKE
自动管理SA建立协商修改删除 是IPSec唯一的密钥管理协议      ISAKMP的通用框架   OAKLEY密钥交换模式    SKEME共享和更新密钥技术
IKE为IPSec提供服务  密钥交换与管理 身份认证 SA协商与管理
PSK预共享密钥  或者PKI公钥基础设施    PSK基于共享的秘密密钥   PKI基于公开/私有密钥对以及证书
阶段1 建立双向IKE SA    野蛮模式 主模式       阶段2 基于ISAKMP协议 基于IPsec SA的安全协商
IKE用于交换算法 秘密密钥 SPI    采用AH协议或ESP协议    IPsec对等端可以是两个端/路由/防火墙 或交叉

无线局域网的安全
有线等效保密  对称密钥加密 机密性 主机认证 数据完整性   自同步 每个分组单独加密 给定加密分组和密钥便可以解密 即便前序分组丢失也可以继续成功解密分组    高效 可以由硬件软件实现
对称流密码  将密钥流的每个字节与明文的每个字节进行异或 得到密文        RC4算法
每个分组独立加密   WEP解决方案  初始密钥+真对每个分组IV初始向量产生针对每个分组的密钥流
WEP加密 计算完整性校验值ICV 4字节CRC用于数据完整性校验    每端有104位共享密钥    发送端生成24位IV附加到密钥上得到128位密钥    发送端附加keyID     将128位密钥输入到伪随机数发生器产生密钥流     利用RC4对帧中数据+ICV进行加密
WEP解密 接收端提取IV  将IV和共享密钥输入伪随机数发生器得到密钥流    将密钥流与加密部分逐个字节异或解密d得到数据与ICV    利用ICV校验数据完整性
并非所有AP都进行认证 即便是用了WEP    AP会在信标帧中指示是否需要认证    认证需要在关联前进行
破解802.11WEP加密  安全漏洞 每帧1个24位IV 最终会重用    IV以明文传输 重用IV容易被监测
802.11i  改进的安全      多种可选加密方法   密钥分发机制   利用独立于AP的认证服务器    IEEE 服务 认证 访问控制 数据完整性加密
EAP 客户与认证服务器间端-端协议   EAP运行在两段独立链路上  移动端到AP   AP到认证服务器

防火墙
隔离组织内部网络与公共互联网，允许某些分组通过，而阻止其他分组进入/离开内部网络的软/硬件设施
预防拒绝服务攻击DoS  SYN泛洪   预防非法修改/内部数据访问      只允许对内部网络授权访问    三种类型  无状态分组过滤器  有状态分组过滤器  应用网关
内部网络通过路由器防火墙与Internet连接  路由器逐个分组过滤决策是否转发/丢弃分组 依据 源IP地址 目的IP地址   TCP/UDP源 目的端口号    ICMP报文类型   TCP SYN和ACK标志位
ACL 规则表 自顶向下应用于到达分组
有状态分组过滤    无状态 笨拙 不加以区分放行      跟踪每个TCP连接   通过扩展ACL检测链接状态表
应用网关 基于应用数据及IP/TCP/UDP头部字段过滤分组  
局限性  IP欺骗 路由器不知道数据是否来自于源    每个应用需要一个应用网关    客户软件需要配置    过滤器经常对UDP流量使用全通过/全部通过策略     折衷 确定安全级别 通信度     很多安全防护级别很高的网站仍然遭受攻击
